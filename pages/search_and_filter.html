<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Search and Filter - Super Scheduler</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fsupersche6116back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
</head>
<body class="bg-background min-h-screen">
    <!-- Header Navigation -->
    <header class="bg-surface border-b border-slate-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Brand -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <svg class="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                        </svg>
                        <h1 class="text-xl font-semibold text-text-primary">Super Scheduler</h1>
                    </div>
                </div>

                <!-- Navigation Menu -->
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="calendar_dashboard.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                    <i class="fas fa-calendar-alt mr-2"></i>Dashboard
                    
                    </a>
                    <a href="task_management.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-tasks mr-2"></i>Tasks
                    </a>
                    <a href="search_and_filter.html" class="text-primary font-medium px-3 py-2 rounded-md bg-primary-50">
                        <i class="fas fa-search mr-2"></i>Search
                    </a>
                    <a href="settings_and_preferences.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </a>
                </nav>

                <!-- Mobile Menu Button -->
                <button class="md:hidden p-2 rounded-md text-text-secondary hover:text-primary hover:bg-slate-50" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobileMenu" class="md:hidden hidden border-t border-slate-200 py-4">
                <div class="flex flex-col space-y-2">
                    <a href="calendar_dashboard.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-calendar-alt mr-2"></i>Dashboard
                    </a>
                    
                    </a>
                    <a href="task_management.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-tasks mr-2"></i>Tasks
                    </a>
                    <a href="search_and_filter.html" class="text-primary font-medium px-3 py-2 rounded-md bg-primary-50">
                        <i class="fas fa-search mr-2"></i>Search
                    </a>
                    <a href="settings_and_preferences.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <!-- Page Header -->
        <div class="mb-6">
            <h2 class="text-2xl font-semibold text-text-primary mb-2">Search & Filter</h2>
            <p class="text-text-secondary">Find events and tasks quickly with search that includes Dashboard and Tasks</p>
        </div>

        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Search and Filter Sidebar -->
            <aside class="lg:w-80 order-2 lg:order-1">
                <!-- Search Section -->
                <div class="card p-6 mb-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i class="fas fa-search text-primary mr-2"></i>
                        Search
                    </h3>
                    <div class="relative mb-4">
                        <input type="text" id="searchInput" placeholder="Search events and tasks..." class="form-input pl-10 pr-10" oninput="performSearch()" onkeydown="handleSearchKeydown(event)" />
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-text-secondary"></i>
                        <button id="clearSearch" onclick="clearSearch()" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-text-secondary hover:text-primary hidden" aria-label="Clear search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <!-- Suggestions (kept visually but functional) -->
                    <div id="searchSuggestions" class="hidden bg-surface border border-slate-200 rounded-md shadow-lg absolute z-10 w-full mt-1">
                        <div class="p-2 space-y-1">
                            <div class="px-3 py-2 hover:bg-slate-50 cursor-pointer rounded text-sm" onclick="selectSuggestion('meeting')">
                                <i class="fas fa-search mr-2 text-text-secondary"></i>meeting
                            </div>
                            <div class="px-3 py-2 hover:bg-slate-50 cursor-pointer rounded text-sm" onclick="selectSuggestion('project')">
                                <i class="fas fa-search mr-2 text-text-secondary"></i>project
                            </div>
                            <div class="px-3 py-2 hover:bg-slate-50 cursor-pointer rounded text-sm" onclick="selectSuggestion('appointment')">
                                <i class="fas fa-search mr-2 text-text-secondary"></i>appointment
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Advanced Filters -->
                <div class="card p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-text-primary flex items-center">
                            <i class="fas fa-filter text-secondary mr-2"></i>
                            Filters
                        </h3>
                        <button onclick="clearAllFilters()" class="text-sm text-primary hover:text-primary-700">
                            Clear All
                        </button>
                    </div>

                    <!-- Date Range Filter -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-text-primary mb-2">Date Range</label>
                        <div class="space-y-2">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="date" id="startDate" class="form-input text-sm" onchange="applyFilters()" />
                                <input type="date" id="endDate" class="form-input text-sm" onchange="applyFilters()" />
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button onclick="setDateRange('today')" class="px-3 py-1 text-xs bg-slate-100 text-slate-600 rounded-full hover:bg-slate-200 transition-colors">
                                    Today
                                </button>
                                <button onclick="setDateRange('week')" class="px-3 py-1 text-xs bg-slate-100 text-slate-600 rounded-full hover:bg-slate-200 transition-colors">
                                    This Week
                                </button>
                                <button onclick="setDateRange('month')" class="px-3 py-1 text-xs bg-slate-100 text-slate-600 rounded-full hover:bg-slate-200 transition-colors">
                                    This Month
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Category Filter -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-text-primary mb-2">Categories</label>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="work" onchange="applyFilters()" />
                                <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                                <span class="text-sm text-text-primary">Work</span>
                                <span class="text-xs text-text-secondary ml-auto">—</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="personal" onchange="applyFilters()" />
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span class="text-sm text-text-primary">Personal</span>
                                <span class="text-xs text-text-secondary ml-auto">—</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="health" onchange="applyFilters()" />
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span class="text-sm text-text-primary">Health</span>
                                <span class="text-xs text-text-secondary ml-auto">—</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="social" onchange="applyFilters()" />
                                <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                                <span class="text-sm text-text-primary">Social</span>
                                <span class="text-xs text-text-secondary ml-auto">—</span>
                            </label>
                        </div>
                    </div>

                    <!-- Type Filter -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-text-primary mb-2">Type</label>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" checked id="typeEvents" class="w-4 h-4 text-primary" onchange="applyFilters()" />
                                <i class="fas fa-calendar-alt text-accent w-4"></i>
                                <span class="text-sm text-text-primary">Events</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" checked id="typeTasks" class="w-4 h-4 text-primary" onchange="applyFilters()" />
                                <i class="fas fa-tasks text-warning w-4"></i>
                                <span class="text-sm text-text-primary">Tasks</span>
                            </label>
                        </div>
                    </div>

                    <!-- Status Filter (applies to tasks) -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-text-primary mb-2">Status (tasks)</label>
                        <div class="space-y-2">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" checked class="w-4 h-4 text-primary status-filter" data-status="completed" onchange="applyFilters()" />
                                <div class="w-3 h-3 bg-success rounded-full"></div>
                                <span class="text-sm text-text-primary">Completed</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" checked class="w-4 h-4 text-primary status-filter" data-status="pending" onchange="applyFilters()" />
                                <div class="w-3 h-3 bg-warning rounded-full"></div>
                                <span class="text-sm text-text-primary">Pending</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="checkbox" checked class="w-4 h-4 text-primary status-filter" data-status="overdue" onchange="applyFilters()" />
                                <div class="w-3 h-3 bg-error rounded-full"></div>
                                <span class="text-sm text-text-primary">Overdue</span>
                            </label>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Search Results -->
            <main class="flex-1 order-1 lg:order-2">
                <!-- Results Header -->
                <div class="card p-6 mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <div class="flex items-center space-x-4">
                            <h3 class="text-lg font-semibold text-text-primary">
                                Search Results
                                <span id="resultCount" class="text-sm font-normal text-text-secondary ml-2">(0 items)</span>
                            </h3>
                        </div>

                        <!-- Active Filters Display -->
                        <div id="activeFilters" class="flex flex-wrap gap-2 mt-4 sm:mt-0"></div>
                    </div>
                </div>

                <!-- Search Results List -->
                <div id="searchResults" class="space-y-4">
                    <!-- Results will be rendered here -->
                </div>

                <!-- Load More Button -->
                <div class="text-center mt-8" id="loadMoreWrapper" style="display:none;">
                    <button onclick="loadMoreResults()" class="btn-secondary">
                        <i class="fas fa-chevron-down mr-2"></i>Load More Results
                    </button>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
                <i id="toastIcon" class="fas fa-check-circle text-success"></i>
            </div>
            <div>
                <p id="toastMessage" class="text-sm font-medium text-text-primary">Search completed successfully!</p>
            </div>
            <button onclick="hideToast()" class="ml-auto text-text-secondary hover:text-text-primary">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Save Search Modal removed per your request -->

    <script>
        // --------- Utility & UI helpers ---------
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');

            messageEl.textContent = message;
            icon.className = type === 'success' ? 'fas fa-check-circle text-success' :
                           type === 'error' ? 'fas fa-exclamation-circle text-error' :
                           'fas fa-info-circle text-accent';

            toast.classList.add('show');
            setTimeout(() => hideToast(), 3000);
        }

        function hideToast() {
            document.getElementById('toast').classList.remove('show');
        }

        // --------- Data loading ---------
        function loadAllEvents() {
            try {
                const raw = localStorage.getItem('calendarEvents') || '[]';
                return JSON.parse(raw);
            } catch (e) {
                console.error('Failed to parse calendarEvents', e);
                return [];
            }
        }

        function loadAllTasks() {
            try {
                const raw = localStorage.getItem('tasks') || '[]';
                return JSON.parse(raw);
            } catch (e) {
                console.error('Failed to parse tasks', e);
                return [];
            }
        }

        function getTaskStatus(task) {
            if (!task) return 'pending';
            if (task.status === 'completed') return 'completed';
            const due = new Date(task.dueDate);
            const now = new Date();
            if (isNaN(due.getTime())) return 'pending';
            return due < now ? 'overdue' : 'pending';
        }

        // --------- Search & Filter Logic ---------
        function performSearch() {
            const term = document.getElementById('searchInput').value.trim().toLowerCase();
            document.getElementById('clearSearch').classList.toggle('hidden', term.length === 0);

            // Show suggestions when user typed >2 chars
            const suggestions = document.getElementById('searchSuggestions');
            if (term.length > 2) suggestions.classList.remove('hidden');
            else suggestions.classList.add('hidden');

            applyFilters(); // perform filtering + searching
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').classList.add('hidden');
            document.getElementById('searchSuggestions').classList.add('hidden');
            applyFilters();
        }

        function selectSuggestion(term) {
            document.getElementById('searchInput').value = term;
            document.getElementById('searchSuggestions').classList.add('hidden');
            applyFilters();
        }

        function handleSearchKeydown(e) {
            if (e.key === 'Escape') {
                document.getElementById('searchSuggestions').classList.add('hidden');
            }
        }

        function applyFilters() {
            // gather raw data
            const allEvents = loadAllEvents();
            const allTasks = loadAllTasks();

            const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
            const startDateVal = document.getElementById('startDate').value;
            const endDateVal = document.getElementById('endDate').value;

            // categories
            const selectedCategories = Array.from(document.querySelectorAll('.category-filter'))
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.category);

            // type
            const showEvents = document.getElementById('typeEvents').checked;
            const showTasks = document.getElementById('typeTasks').checked;

            // statuses
            const selectedStatuses = Array.from(document.querySelectorAll('.status-filter'))
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.status);

            // filter events
            let events = allEvents.slice();
            if (searchTerm) {
                events = events.filter(ev =>
                    (ev.title && ev.title.toLowerCase().includes(searchTerm)) ||
                    (ev.description && ev.description.toLowerCase().includes(searchTerm)) ||
                    (ev.location && ev.location.toLowerCase().includes(searchTerm))
                );
            }
            if (selectedCategories.length) {
                events = events.filter(ev => selectedCategories.includes(ev.category));
            }
            if (startDateVal && endDateVal) {
                const start = new Date(startDateVal);
                const end = new Date(endDateVal);
                events = events.filter(ev => {
                    const d = new Date(ev.date);
                    return !isNaN(d.getTime()) && d >= start && d <= end;
                });
            }

            // filter tasks
            let tasks = allTasks.slice();
            if (searchTerm) {
                tasks = tasks.filter(t =>
                    (t.title && t.title.toLowerCase().includes(searchTerm)) ||
                    (t.description && t.description.toLowerCase().includes(searchTerm))
                );
            }
            if (selectedCategories.length) {
                tasks = tasks.filter(t => selectedCategories.includes(t.category));
            }
            if (startDateVal && endDateVal) {
                const start = new Date(startDateVal);
                const end = new Date(endDateVal);
                tasks = tasks.filter(t => {
                    const d = new Date(t.dueDate);
                    return !isNaN(d.getTime()) && d >= start && d <= end;
                });
            }

            // apply type toggles
            if (!showEvents) events = [];
            if (!showTasks) tasks = [];

            // map into unified results
            const results = [];
            events.forEach(ev => results.push({ type: 'event', id: ev.id, title: ev.title, description: ev.description || '', date: ev.date, time: ev.time, category: ev.category, raw: ev }));
            tasks.forEach(t => results.push({ type: 'task', id: t.id, title: t.title, description: t.description || '', dueDate: t.dueDate, category: t.category, status: getTaskStatus(t), raw: t }));

            // status filtering (only for tasks)
            let finalResults = results;
            if (selectedStatuses.length > 0) {
                finalResults = results.filter(r => {
                    if (r.type === 'task') return selectedStatuses.includes(r.status);
                    return true; // keep events
                });
            }

            // sort by date (events by date, tasks by dueDate) newest-first
            finalResults.sort((a, b) => {
                const da = a.type === 'event' ? (a.date ? new Date(a.date) : new Date(0)) : (a.dueDate ? new Date(a.dueDate) : new Date(0));
                const db = b.type === 'event' ? (b.date ? new Date(b.date) : new Date(0)) : (b.dueDate ? new Date(b.dueDate) : new Date(0));
                return db - da;
            });

            renderResults(finalResults);
            updateResultCount(finalResults.length);
            updateActiveFiltersDisplay(selectedCategories, startDateVal, endDateVal, showEvents, showTasks, selectedStatuses);
        }

        function renderResults(results) {
            const container = document.getElementById('searchResults');
            container.innerHTML = '';

            if (!results.length) {
                container.innerHTML = `
                    <div class="card p-6 text-center">
                        <p class="text-sm text-text-secondary">No results found</p>
                    </div>
                `;
                document.getElementById('loadMoreWrapper').style.display = 'none';
                return;
            }

            // Render each result using card style similar to examples
            results.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card p-6 hover:shadow-md transition-shadow';

                const left = document.createElement('div');
                left.className = 'flex-1';

                // header info (category dot, type, date)
                const headerRow = document.createElement('div');
                headerRow.className = 'flex items-center space-x-3 mb-2';

                const dot = document.createElement('div');
                dot.className = 'w-3 h-3 rounded-full ' + getCategoryDotClass(item.category);
                headerRow.appendChild(dot);

                const typeSpan = document.createElement('span');
                typeSpan.className = 'text-xs text-text-secondary uppercase tracking-wide';
                typeSpan.textContent = item.type === 'event' ? 'Event' : 'Task';
                headerRow.appendChild(typeSpan);

                const sep = document.createElement('span');
                sep.className = 'text-xs text-text-secondary';
                sep.textContent = '•';
                headerRow.appendChild(sep);

                const dateSpan = document.createElement('span');
                dateSpan.className = 'text-xs text-text-secondary';
                dateSpan.textContent = item.type === 'event' ? (item.date ? formatDateVerbose(item.date, item.time) : 'No date') : (item.dueDate ? `Due: ${new Date(item.dueDate).toLocaleDateString()}` : 'No due date');
                headerRow.appendChild(dateSpan);

                // title
                const titleH4 = document.createElement('h4');
                titleH4.className = 'text-lg font-medium text-text-primary mb-2';
                titleH4.innerHTML = escapeHtml(item.title || '(No title)');

                // description
                const p = document.createElement('p');
                p.className = 'text-sm text-text-secondary mb-3';
                p.textContent = item.description || '';

                // badges/actions row
                const actionsRow = document.createElement('div');
                actionsRow.className = 'flex items-center space-x-4 text-xs text-text-secondary';
                if (item.type === 'event') {
                    const durSpan = document.createElement('span');
                    durSpan.innerHTML = `<i class="fas fa-clock mr-1"></i>${item.time || '—'}`;
                    actionsRow.appendChild(durSpan);
                } else {
                    const taskSpan = document.createElement('span');
                    taskSpan.innerHTML = `<i class="fas fa-tasks mr-1"></i>Task`;
                    actionsRow.appendChild(taskSpan);

                    const statusBadge = document.createElement('span');
                    const status = item.status || getTaskStatus(item.raw);
                    if (status === 'completed') {
                        statusBadge.className = 'inline-flex items-center px-2 py-1 rounded-full bg-success-100 text-success-700';
                        statusBadge.innerHTML = '<i class="fas fa-check mr-1"></i>Completed';
                    } else if (status === 'overdue') {
                        statusBadge.className = 'inline-flex items-center px-2 py-1 rounded-full bg-error-100 text-error-700';
                        statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>Overdue';
                    } else {
                        statusBadge.className = 'inline-flex items-center px-2 py-1 rounded-full bg-warning-100 text-warning-700';
                        statusBadge.innerHTML = '<i class="fas fa-clock mr-1"></i>Pending';
                    }
                    actionsRow.appendChild(statusBadge);
                }

                // right-side action buttons
                const rightActions = document.createElement('div');
                rightActions.className = 'flex items-center space-x-2 ml-4';
                rightActions.innerHTML = `
                    <button class="p-2 text-text-secondary hover:text-primary hover:bg-slate-50 rounded-md transition-colors" title="Edit" onclick="editItem('${item.type}-${item.id}')"><i class="fas fa-edit"></i></button>
                    <button class="p-2 text-text-secondary hover:text-accent hover:bg-slate-50 rounded-md transition-colors" title="View" onclick="viewItem('${item.type}-${item.id}')"><i class="fas fa-eye"></i></button>
                    <button class="p-2 text-text-secondary hover:text-error hover:bg-slate-50 rounded-md transition-colors" title="Delete" onclick="deleteItem('${item.type}-${item.id}', this)"><i class="fas fa-trash"></i></button>
                `;

                // assemble
                left.appendChild(headerRow);
                left.appendChild(titleH4);
                left.appendChild(p);
                left.appendChild(actionsRow);

                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-start justify-between';
                wrapper.appendChild(left);
                wrapper.appendChild(rightActions);

                card.appendChild(wrapper);
                document.getElementById('searchResults').appendChild(card);
            });

            // Show load more if many results (we keep hidden for now)
            document.getElementById('loadMoreWrapper').style.display = 'none';
        }

        function formatDateVerbose(dateStr, timeStr) {
            if (!dateStr) return '';
            try {
                const d = new Date(dateStr);
                const datePart = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                if (timeStr) {
                    // try parse time "HH:MM" and format
                    return `${datePart} at ${timeStr}`;
                }
                return datePart;
            } catch {
                return dateStr;
            }
        }

        function getCategoryDotClass(category) {
            switch (category) {
                case 'work': return 'bg-blue-500';
                case 'personal': return 'bg-green-500';
                case 'health': return 'bg-red-500';
                case 'social': return 'bg-purple-500';
                default: return 'bg-slate-400';
            }
        }

        function escapeHtml(s) {
            if (!s) return '';
            return s.replace(/[&<>"']/g, function (m) {
                return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];
            });
        }

        // --------- Actions (edit/view/delete) ---------
        function editItem(id) {
            // id format: "event-<id>" or "task-<id>"
            if (!id) return;
            if (id.startsWith('event-')) {
                // routing: open dashboard event edit (keeps search disconnected from create-event page)
                const rawId = id.split('-').slice(1).join('-');
                // If you have an edit route/modal, hook it here. As placeholder, navigate to dashboard and attempt to open
                // For now navigate to calendar dashboard; user requested no reliance on create-event tab.
                window.location.href = 'calendar_dashboard.html';
            } else {
                window.location.href = 'task_management.html';
            }
        }

        function viewItem(id) {
            showToast('Opening item details...', 'info');
            // Real implementation would open a modal. For now placeholder.
        }

        function deleteItem(id, el) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            if (!id) return;

            if (id.startsWith('event-')) {
                const rawId = id.split('-').slice(1).join('-');
                let events = loadAllEvents();
                events = events.filter(e => e.id !== rawId);
                localStorage.setItem('calendarEvents', JSON.stringify(events));
            } else {
                const rawId = id.split('-').slice(1).join('-');
                let tasks = loadAllTasks();
                tasks = tasks.filter(t => t.id !== rawId);
                localStorage.setItem('tasks', JSON.stringify(tasks));
            }

            // Remove the card from DOM for immediate feedback
            const card = el ? el.closest('.card') : null;
            if (card) card.remove();

            // Re-run filters
            applyFilters();
            showToast('Item deleted successfully', 'success');
        }

        function completeTask(id) {
            // mark a task completed (id may come from task-<id>)
            if (!id) return;
            const rawId = id.split('-').slice(1).join('-');
            const tasks = loadAllTasks().map(t => {
                if (t.id === rawId) {
                    t.status = 'completed';
                }
                return t;
            });
            localStorage.setItem('tasks', JSON.stringify(tasks));
            applyFilters();
            showToast('Task marked complete', 'success');
        }

        // --------- Filters UI helpers ---------
        function updateResultCount(count) {
            document.getElementById('resultCount').textContent = `(${count} items)`;
        }

        function updateActiveFiltersDisplay(categories, startDateVal, endDateVal, showEvents, showTasks, statuses) {
            const out = document.getElementById('activeFilters');
            out.innerHTML = '';

            if (categories && categories.length) {
                categories.forEach(cat => {
                    const span = document.createElement('span');
                    span.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs bg-primary-100 text-primary-700';
                    span.innerHTML = `${cat.charAt(0).toUpperCase() + cat.slice(1)} <button onclick="removeFilterAndApply('category','${cat}')" class="ml-2 text-primary-500 hover:text-primary-700"><i class="fas fa-times"></i></button>`;
                    out.appendChild(span);
                });
            }

            if (startDateVal && endDateVal) {
                const span = document.createElement('span');
                span.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs bg-accent-100 text-accent-700';
                span.innerHTML = `From ${startDateVal} to ${endDateVal} <button onclick="removeFilterAndApply('date')" class="ml-2 text-accent-500 hover:text-accent-700"><i class="fas fa-times"></i></button>`;
                out.appendChild(span);
            }

            if (!showEvents) {
                const span = document.createElement('span');
                span.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs bg-slate-100 text-text-secondary';
                span.innerHTML = `Events hidden <button onclick="toggleType('events')" class="ml-2 text-text-secondary hover:text-primary"><i class="fas fa-eye"></i></button>`;
                out.appendChild(span);
            }
            if (!showTasks) {
                const span = document.createElement('span');
                span.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs bg-slate-100 text-text-secondary';
                span.innerHTML = `Tasks hidden <button onclick="toggleType('tasks')" class="ml-2 text-text-secondary hover:text-primary"><i class="fas fa-eye"></i></button>`;
                out.appendChild(span);
            }

            if (statuses && statuses.length) {
                statuses.forEach(st => {
                    const span = document.createElement('span');
                    span.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs bg-warning-100 text-warning-700';
                    span.innerHTML = `${st.charAt(0).toUpperCase() + st.slice(1)} <button onclick="removeFilterAndApply('status','${st}')" class="ml-2 text-warning-500 hover:text-warning-700"><i class="fas fa-times"></i></button>`;
                    out.appendChild(span);
                });
            }
        }

        function removeFilterAndApply(type, value) {
            if (type === 'category') {
                document.querySelectorAll(`.category-filter[data-category="${value}"]`).forEach(cb => cb.checked = false);
            } else if (type === 'date') {
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
            } else if (type === 'status') {
                document.querySelectorAll(`.status-filter[data-status="${value}"]`).forEach(cb => cb.checked = false);
            }
            applyFilters();
        }

        function toggleType(which) {
            if (which === 'events') {
                const el = document.getElementById('typeEvents');
                el.checked = !el.checked;
            } else {
                const el = document.getElementById('typeTasks');
                el.checked = !el.checked;
            }
            applyFilters();
        }

        function clearAllFilters() {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('clearSearch').classList.add('hidden');
            applyFilters();
            showToast('All filters cleared', 'info');
        }

        function setDateRange(range) {
            const today = new Date();
            const startDate = document.getElementById('startDate');
            const endDate = document.getElementById('endDate');

            if (range === 'today') {
                startDate.value = today.toISOString().split('T')[0];
                endDate.value = today.toISOString().split('T')[0];
            } else if (range === 'week') {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - today.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                startDate.value = weekStart.toISOString().split('T')[0];
                endDate.value = weekEnd.toISOString().split('T')[0];
            } else if (range === 'month') {
                const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                startDate.value = monthStart.toISOString().split('T')[0];
                endDate.value = monthEnd.toISOString().split('T')[0];
            }
            applyFilters();
        }

        // --------- Storage listener so search updates when events/tasks are created elsewhere ---------
        window.addEventListener('storage', function (e) {
            // if calendarEvents or tasks changed in another tab/window, re-apply filters
            if (e.key === 'calendarEvents' || e.key === 'tasks') {
                applyFilters();
            }
        });

        // --------- Initialization ---------
        document.addEventListener('DOMContentLoaded', function () {
            // set dates to by default
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';

            // initial run
            applyFilters();

            // hide suggestions on outside click
            document.addEventListener('click', function (ev) {
                const suggestions = document.getElementById('searchSuggestions');
                const searchInput = document.getElementById('searchInput');
                if (!suggestions.contains(ev.target) && ev.target !== searchInput) {
                    suggestions.classList.add('hidden');
                }
            });

            // keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
            });
        });

        // small helpers for demo features
        function loadMoreResults() {
            showToast('Loading more results...', 'info');
        }
    </script>
<script id="dhws-dataInjector" src="../public/dhws-data-injector.js"></script>
</body>
</html>
