<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calendar Dashboard - Super Scheduler</title>
    <link rel="stylesheet" href="../css/main.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
    <script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fsupersche6116back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
</head>
<body class="bg-background min-h-screen">
    <!-- Header Navigation -->
    <header class="bg-surface border-b border-slate-200 shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo and Brand -->
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2">
                        <svg class="w-8 h-8 text-primary" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
                        </svg>
                        <h1 class="text-xl font-semibold text-text-primary">Super Scheduler</h1>
                    </div>
                </div>

                <!-- Navigation Menu (Create Event removed) -->
                <nav class="hidden md:flex items-center space-x-6">
                    <a href="calendar_dashboard.html" class="text-primary font-medium px-3 py-2 rounded-md bg-primary-50">
                        <i class="fas fa-calendar-alt mr-2"></i>Dashboard
                    </a>
                    <a href="task_management.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-tasks mr-2"></i>Tasks
                    </a>
                    <a href="search_and_filter.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-search mr-2"></i>Search
                    </a>
                    <a href="settings_and_preferences.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </a>
                </nav>

                <!-- Mobile Menu Button -->
                <button class="md:hidden p-2 rounded-md text-text-secondary hover:text-primary hover:bg-slate-50" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>

            <!-- Mobile Navigation Menu (Create Event removed) -->
            <div id="mobileMenu" class="md:hidden hidden border-t border-slate-200 py-4">
                <div class="flex flex-col space-y-2">
                    <a href="calendar_dashboard.html" class="text-primary font-medium px-3 py-2 rounded-md bg-primary-50">
                        <i class="fas fa-calendar-alt mr-2"></i>Dashboard
                    </a>
                    <a href="task_management.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-tasks mr-2"></i>Tasks
                    </a>
                    <a href="search_and_filter.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-search mr-2"></i>Search
                    </a>
                    <a href="settings_and_preferences.html" class="text-text-secondary hover:text-primary px-3 py-2 rounded-md hover:bg-slate-50 transition-colors">
                        <i class="fas fa-cog mr-2"></i>Settings
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Sidebar -->
            <aside class="lg:w-80 order-2 lg:order-1">
                <!-- Quick Event Creation -->
                <div class="card p-6 mb-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i class="fas fa-plus-circle text-primary mr-2"></i>
                        Quick Event
                    </h3>
                    <form class="space-y-4" onsubmit="createQuickEvent(event)">
                        <div>
                            <input type="text" id="quickEventTitle" placeholder="Event title" class="form-input text-sm" required />
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="date" id="quickEventDate" class="form-input text-sm" required />
                            <input type="time" id="quickEventTime" class="form-input text-sm" required />
                        </div>
                        <!-- Inline conflict / validation warning for quick event -->
                        <p id="quickEventError" class="text-xs text-error mt-1 hidden"></p>
                        <div>
                            <select id="quickEventCategory" class="form-input text-sm">
                                <option value="work">Work</option>
                                <option value="personal">Personal</option>
                                <option value="health">Health</option>
                                <option value="social">Social</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary w-full text-sm">
                            <i class="fas fa-plus mr-2"></i>Add Event
                        </button>
                    </form>
                </div>

                <!-- Upcoming Tasks -->
                <div class="card p-6 mb-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i class="fas fa-clock text-accent mr-2"></i>
                        Upcoming Tasks
                    </h3>
                    <div id="upcomingTasksContainer" class="space-y-3">
                        <!-- Tasks will be populated by JavaScript -->
                    </div>
                    <a href="task_management.html" class="block mt-4 text-center text-sm text-primary hover:text-primary-700 font-medium">
                        View All Tasks <i class="fas fa-arrow-right ml-1"></i>
                    </a>
                </div>

                <!-- Category Filters -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-text-primary mb-4 flex items-center">
                        <i class="fas fa-filter text-secondary mr-2"></i>
                        Categories
                    </h3>
                    <div class="space-y-3">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="work" onchange="filterEventsByCategory()" />
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span class="text-sm text-text-primary">Work</span>
                            <span class="text-xs text-text-secondary ml-auto category-count" data-category="work">0</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="personal" onchange="filterEventsByCategory()" />
                            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                            <span class="text-sm text-text-primary">Personal</span>
                            <span class="text-xs text-text-secondary ml-auto category-count" data-category="personal">0</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="health" onchange="filterEventsByCategory()" />
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span class="text-sm text-text-primary">Health</span>
                            <span class="text-xs text-text-secondary ml-auto category-count" data-category="health">0</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" checked class="w-4 h-4 text-primary category-filter" data-category="social" onchange="filterEventsByCategory()" />
                            <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
                            <span class="text-sm text-text-primary">Social</span>
                            <span class="text-xs text-text-secondary ml-auto category-count" data-category="social">0</span>
                        </label>
                    </div>
                </div>
            </aside>

            <!-- Main Calendar Area -->
            <main class="flex-1 order-1 lg:order-2">
                <!-- Calendar Header -->
                <div class="card p-6 mb-6">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <!-- Date Navigation -->
                        <div class="flex items-center space-x-4">
                            <button onclick="navigateDate('prev')" class="p-2 rounded-md text-text-secondary hover:text-primary hover:bg-slate-50 transition-colors">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h2 id="currentDate" class="text-2xl font-semibold text-text-primary">October 2025</h2>
                            <button onclick="navigateDate('next')" class="p-2 rounded-md text-text-secondary hover:text-primary hover:bg-slate-50 transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                            <button onclick="goToToday()" class="btn-secondary text-sm">Today</button>
                        </div>

                        <!-- View Toggle REMOVED on purpose (Month/Week/Day/Agenda) -->
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="card p-6">
                    <!-- Calendar Days Header -->
                    <div class="calendar-grid mb-2">
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Sun</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Mon</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Tue</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Wed</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Thu</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Fri</div>
                        <div class="text-center py-3 text-sm font-medium text-text-secondary">Sat</div>
                    </div>

                    <!-- Calendar Body -->
                    <div id="calendarGrid" class="calendar-grid">
                        <!-- Calendar cells will be generated by JavaScript -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-20 right-4 p-4 rounded-lg border shadow-lg bg-white transform translate-x-full transition-transform duration-300 z-50 max-w-sm">
        <div class="flex items-center space-x-3">
            <div class="flex-shrink-0">
                <i id="toastIcon" class="fas fa-check-circle text-success"></i>
            </div>
            <div class="flex-1">
                <p id="toastMessage" class="text-sm font-medium text-text-primary">Event created successfully!</p>
            </div>
            <button onclick="hideToast()" class="ml-auto text-text-secondary hover:text-text-primary">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Event Edit Modal -->
    <div id="eventModal" class="modal-overlay hidden" onclick="closeModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-text-primary">Edit Event</h3>
                <button onclick="closeModal()" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form class="space-y-4" onsubmit="saveEventModal(event)">
                <input type="hidden" id="editEventId" />
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-1">Title</label>
                    <input type="text" id="eventTitle" class="form-input" required />
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-1">Date</label>
                        <input type="date" id="eventDate" class="form-input" required />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-1">Time</label>
                        <input type="time" id="eventTime" class="form-input" required />
                    </div>
                </div>
                <!-- Inline conflict warning for modal -->
                <p id="modalEventError" class="text-xs text-error mt-1 hidden"></p>
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-1">Category</label>
                    <select id="eventCategory" class="form-input">
                        <option value="work">Work</option>
                        <option value="personal">Personal</option>
                        <option value="health">Health</option>
                        <option value="social">Social</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-text-primary mb-1">Description</label>
                    <textarea id="eventDescription" class="form-input" rows="3" placeholder="Event description..."></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="deleteEventFromModal()" class="px-4 py-2 text-error hover:bg-error-100 rounded-md transition-colors">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                    <button type="button" onclick="closeModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentDate = new Date();
        let events = [];
        let editingEventId = null;

        // Reminder settings (loaded from schedulerSettings)
        let reminderSettings = {
            eventReminderMinutes: 5,  // default 5 minutes
            soundEnabled: true,
            browserNotifications: true
        };
        let timeFormatSetting = '12';
        let reminderTimers = {};
        let remindedEvents = new Set();

        // ------------- Local Storage helpers -------------

        function saveEventsToStorage() {
            try {
                localStorage.setItem('calendarEvents', JSON.stringify(events));
            } catch (err) {
                console.error('Failed to save events to storage', err);
            }
        }

        function loadEventsFromStorage() {
            try {
                const stored = localStorage.getItem('calendarEvents');
                events = stored ? JSON.parse(stored) : [];
                if (!Array.isArray(events)) events = [];
            } catch (err) {
                console.error('Failed to load events from storage', err);
                events = [];
            }
            scheduleRemindersForAllEvents();
        }

        function loadReminderSettings() {
            try {
                const raw = localStorage.getItem('schedulerSettings');
                if (!raw) return;
                const cfg = JSON.parse(raw);

                // Time format
                if (cfg.timeFormat === '24') {
                    timeFormatSetting = '24';
                } else {
                    timeFormatSetting = '12';
                }

                // Event reminder minutes
                if (cfg.eventReminder) {
                    if (cfg.eventReminder === 'none') {
                        reminderSettings.eventReminderMinutes = null;
                    } else {
                        const m = parseInt(cfg.eventReminder, 10);
                        if (!isNaN(m)) reminderSettings.eventReminderMinutes = m;
                    }
                }

                // Sound on/off
                if (typeof cfg.soundEnabled === 'boolean') {
                    reminderSettings.soundEnabled = cfg.soundEnabled;
                }

                // Browser notifications on/off
                if (typeof cfg.browserNotifications === 'boolean') {
                    reminderSettings.browserNotifications = cfg.browserNotifications;
                }
            } catch (e) {
                console.error('Failed to load reminder/settings config', e);
            }
        }

        // ------------- Time formatting -------------

        function formatTimeForDisplay(timeStr) {
            if (!timeStr) return '';
            // Expect "HH:MM"
            const parts = timeStr.split(':');
            if (parts.length < 2) return timeStr;
            const hStr = parts[0];
            const mStr = parts[1];
            let h = parseInt(hStr, 10);
            if (isNaN(h)) return timeStr;

            if (timeFormatSetting === '24') {
                // Keep 24h as stored
                return `${hStr.padStart(2, '0')}:${mStr.padStart(2, '0')}`;
            }

            // 12-hour format
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            if (h === 0) h = 12;
            return `${h}:${mStr.padStart(2, '0')} ${ampm}`;
        }

        // ------------- Reminder scheduling -------------

        function clearAllReminderTimers() {
            Object.values(reminderTimers).forEach(id => clearTimeout(id));
            reminderTimers = {};
        }

        function scheduleRemindersForAllEvents() {
            clearAllReminderTimers();
            if (reminderSettings.eventReminderMinutes == null) return;

            const now = new Date();

            events.forEach(ev => {
                if (!ev || !ev.id || !ev.date || !ev.time) return;

                const eventDateTime = new Date(ev.date + 'T' + ev.time);
                if (isNaN(eventDateTime.getTime())) return;

                const reminderTime = new Date(
                    eventDateTime.getTime() - reminderSettings.eventReminderMinutes * 60000
                );

                if (reminderTime <= now) {
                    return; // too late to schedule
                }

                const delay = reminderTime.getTime() - now.getTime();
                reminderTimers[ev.id] = setTimeout(() => {
                    if (remindedEvents.has(ev.id)) return;
                    remindedEvents.add(ev.id);
                    triggerEventReminder(ev);
                }, delay);
            });
        }

        function requestNotificationPermissionIfNeeded() {
            if (!('Notification' in window)) return;

            if (Notification.permission === 'default') {
                Notification.requestPermission().then(() => {});
            }
        }

        function showBrowserNotification(title, body) {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'granted') {
                new Notification(title, { body });
            }
        }

        function triggerEventReminder(ev) {
            const title = ev.title || 'Event';
            const time = ev.time ? formatTimeForDisplay(ev.time) : '';
            const date = ev.date || '';

            const body = time && date ? `${time} on ${date}` : (time || date || '');

            showToast(`Reminder: "${title}" ${body ? ' — ' + body : ''}`, 'info');

            if (reminderSettings.browserNotifications) {
                if (Notification.permission === 'granted') {
                    showBrowserNotification(title, body || 'Event reminder');
                } else if (Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            showBrowserNotification(title, body || 'Event reminder');
                        }
                    });
                }
            }

            if (reminderSettings.soundEnabled) {
                playReminderSound();
            }
        }

        function playReminderSound() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;

                const ctx = new AudioContext();
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.type = 'sine';
                oscillator.frequency.value = 880; // Beep

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                gainNode.gain.setValueAtTime(0.0001, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.4, ctx.currentTime + 0.01);

                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 1);
                oscillator.stop(ctx.currentTime + 1);
            } catch (e) {
                console.error('Failed to play reminder sound', e);
            }
        }

        // ------------- Event helpers -------------

        function generateEventId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 9);
        }

        function getCategoryColors(category) {
            const colors = {
                work: { bg: 'bg-blue-100', text: 'text-blue-800', border: 'border-blue-500' },
                personal: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-500' },
                health: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-500' },
                social: { bg: 'bg-purple-100', text: 'text-purple-800', border: 'border-purple-500' }
            };
            return colors[category] || colors.work;
        }

        // Mobile menu toggle
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        // Date navigation
        function navigateDate(direction) {
            if (direction === 'prev') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else {
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
            updateCurrentDateDisplay();
            renderCalendar();
            showToast(`Navigated ${direction === 'prev' ? 'previous' : 'next'} month`, 'info');
        }

        function goToToday() {
            currentDate = new Date();
            updateCurrentDateDisplay();
            renderCalendar();
            showToast('Navigated to today', 'info');
        }

        function updateCurrentDateDisplay() {
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            document.getElementById('currentDate').textContent =
                `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }

        // Calendar rendering
        function renderCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const today = new Date();

            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);

                const cell = document.createElement('div');
                cell.className = 'calendar-cell';
                cell.setAttribute('ondrop', 'dropEvent(event)');
                cell.setAttribute('ondragover', 'allowDrop(event)');
                cell.setAttribute('ondblclick', `quickCreateEvent(event, '${formatDate(cellDate)}')`);

                const dayNumber = document.createElement('div');
                dayNumber.className = cellDate.getMonth() === month
                    ? 'text-sm font-medium text-text-primary mb-2'
                    : 'text-sm text-text-secondary mb-2';
                dayNumber.textContent = cellDate.getDate();

                // Today indicator
                if (cellDate.toDateString() === today.toDateString()) {
                    const todayIndicator = document.createElement('div');
                    todayIndicator.className = 'text-sm bg-primary text-white px-2 py-1 rounded text-center font-medium mb-2';
                    todayIndicator.textContent = 'Today';
                    cell.appendChild(todayIndicator);
                }

                cell.appendChild(dayNumber);

                // Events
                const dateEvents = getEventsForDate(cellDate);
                dateEvents.forEach(ev => {
                    const eventElement = createEventElement(ev);
                    cell.appendChild(eventElement);
                });

                calendarGrid.appendChild(cell);
            }

            updateCategoryCounts();
            filterEventsByCategory();
        }

        function formatDate(date) {
            if (typeof date === 'string') {
                const d = new Date(date);
                if (!isNaN(d)) return d.toISOString().split('T')[0];
                return date.split('T')[0];
            }
            return date.toISOString().split('T')[0];
        }

        function getEventsForDate(date) {
            const dateStr = formatDate(date);
            return events.filter(ev => ev.date === dateStr);
        }

        function createEventElement(ev) {
            const colors = getCategoryColors(ev.category);
            const eventDiv = document.createElement('div');
            eventDiv.className = `event-item ${colors.bg} ${colors.text} border-l-4 ${colors.border} cursor-pointer`;
            eventDiv.setAttribute('draggable', 'true');
            eventDiv.setAttribute('ondragstart', 'dragEvent(event)');
            eventDiv.setAttribute('onclick', `editEvent('${ev.id}')`);
            eventDiv.setAttribute('data-event-id', ev.id);

            const safeTitle = ev.title || '(No title)';
            const safeTime = ev.time ? formatTimeForDisplay(ev.time) : '';

            eventDiv.innerHTML = `
                <span class="text-xs font-medium">${safeTitle}</span>
                <div class="text-xs opacity-75">${safeTime}</div>
            `;

            return eventDiv;
        }

        // Conflict helper
        function hasTimeConflict(date, time, ignoreEventId = null) {
            if (!date || !time) return false;
            const normalizedDate = date.toString().trim();
            const normalizedTime = time.toString().trim();
            return events.some(e => {
                if (!e) return false;
                if (ignoreEventId && e.id === ignoreEventId) return false;
                if (!e.date || !e.time) return false;
                return e.date.toString().trim() === normalizedDate &&
                       e.time.toString().trim() === normalizedTime;
            });
        }

        // Quick create via double-click on calendar cell
        function quickCreateEvent(e, date) {
            e.preventDefault();
            const modal = document.getElementById('eventModal');
            document.getElementById('editEventId').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = date;
            document.getElementById('eventTime').value = '09:00';
            document.getElementById('eventCategory').value = 'work';
            document.getElementById('eventDescription').value = '';
            const modalError = document.getElementById('modalEventError');
            if (modalError) {
                modalError.textContent = '';
                modalError.classList.add('hidden');
            }

            modal.classList.remove('hidden');
            setTimeout(() => {
                document.querySelector('.modal-content').classList.add('show');
            }, 10);
        }

        // Quick event creation from sidebar form
        function createQuickEvent(e) {
            e.preventDefault();

            const titleEl = document.getElementById('quickEventTitle');
            const dateEl = document.getElementById('quickEventDate');
            const timeEl = document.getElementById('quickEventTime');
            const categoryEl = document.getElementById('quickEventCategory');
            const quickError = document.getElementById('quickEventError');

            if (quickError) {
                quickError.textContent = '';
                quickError.classList.add('hidden');
            }

            const title = titleEl.value && titleEl.value.trim();
            const date = dateEl.value && dateEl.value.trim();
            const time = timeEl.value && timeEl.value.trim();
            const category = categoryEl.value && categoryEl.value.trim();

            if (!title || !date || !time) {
                if (quickError) {
                    quickError.textContent = 'Please fill in all required fields.';
                    quickError.classList.remove('hidden');
                }
                showToast('Please fill in all required fields', 'error');
                return;
            }

            if (hasTimeConflict(date, time)) {
                if (quickError) {
                    quickError.textContent = 'Time conflict — this time is already occupied.';
                    quickError.classList.remove('hidden');
                }
                showToast('Time conflict — this time is already occupied.', 'error');
                return;
            }

            const newEvent = {
                id: generateEventId(),
                title,
                date,
                time,
                category,
                description: ''
            };

            events.push(newEvent);
            saveEventsToStorage();
            scheduleRemindersForAllEvents();
            renderCalendar();
            loadUpcomingTasks();

            titleEl.value = '';
            dateEl.value = '';
            timeEl.value = '';
            categoryEl.value = 'work';

            showToast('Event created successfully!', 'success');
        }

        // Edit / Save / Delete event
        function editEvent(eventId) {
            const ev = events.find(e => e.id === eventId);
            if (!ev) return;

            editingEventId = eventId;
            document.getElementById('editEventId').value = eventId;
            document.getElementById('eventTitle').value = ev.title || '';
            document.getElementById('eventDate').value = ev.date || '';
            document.getElementById('eventTime').value = ev.time || '';
            document.getElementById('eventCategory').value = ev.category || 'work';
            document.getElementById('eventDescription').value = ev.description || '';

            const modalError = document.getElementById('modalEventError');
            if (modalError) {
                modalError.textContent = '';
                modalError.classList.add('hidden');
            }

            document.getElementById('eventModal').classList.remove('hidden');
            setTimeout(() => {
                document.querySelector('.modal-content').classList.add('show');
            }, 10);
        }

        function saveEventModal(e) {
            e.preventDefault();
            const eventId = document.getElementById('editEventId').value;
            const title = document.getElementById('eventTitle').value && document.getElementById('eventTitle').value.trim();
            const date = document.getElementById('eventDate').value && document.getElementById('eventDate').value.trim();
            const time = document.getElementById('eventTime').value && document.getElementById('eventTime').value.trim();
            const category = document.getElementById('eventCategory').value && document.getElementById('eventCategory').value.trim();
            const description = document.getElementById('eventDescription').value || '';
            const modalError = document.getElementById('modalEventError');

            if (modalError) {
                modalError.textContent = '';
                modalError.classList.add('hidden');
            }

            if (!title || !date || !time) {
                if (modalError) {
                    modalError.textContent = 'Please fill in all required fields.';
                    modalError.classList.remove('hidden');
                }
                showToast('Please fill in all required fields', 'error');
                return;
            }

            if (eventId) {
                const eventIndex = events.findIndex(e => e.id === eventId);
                if (eventIndex !== -1) {
                    if (hasTimeConflict(date, time, eventId)) {
                        if (modalError) {
                            modalError.textContent = 'Time conflict — this time is already occupied.';
                            modalError.classList.remove('hidden');
                        }
                        showToast('Time conflict — this time is already occupied.', 'error');
                        return;
                    }

                    events[eventIndex] = {
                        ...events[eventIndex],
                        title,
                        date,
                        time,
                        category,
                        description
                    };
                    showToast('Event updated successfully!', 'success');
                }
            } else {
                if (hasTimeConflict(date, time)) {
                    if (modalError) {
                        modalError.textContent = 'Time conflict — this time is already occupied.';
                        modalError.classList.remove('hidden');
                    }
                    showToast('Time conflict — this time is already occupied.', 'error');
                    return;
                }

                const newEvent = {
                    id: generateEventId(),
                    title,
                    date,
                    time,
                    category,
                    description
                };
                events.push(newEvent);
                showToast('Event created successfully!', 'success');
            }

            saveEventsToStorage();
            scheduleRemindersForAllEvents();
            renderCalendar();
            loadUpcomingTasks();
            closeModal();
        }

        function deleteEventFromModal() {
            const eventId = document.getElementById('editEventId').value;
            if (!eventId) return;

            if (confirm('Are you sure you want to delete this event?')) {
                events = events.filter(e => e.id !== eventId);
                saveEventsToStorage();
                scheduleRemindersForAllEvents();
                renderCalendar();
                loadUpcomingTasks();
                showToast('Event deleted successfully', 'success');
                closeModal();
            }
        }

        function closeModal(e) {
            if (e && e.target !== e.currentTarget) return;

            const modalContent = document.querySelector('.modal-content');
            if (!modalContent) {
                document.getElementById('eventModal').classList.add('hidden');
                return;
            }

            modalContent.classList.remove('show');
            setTimeout(() => {
                document.getElementById('eventModal').classList.add('hidden');
            }, 300);
        }

        // Drag and drop
        function dragEvent(e) {
            const eventElement = e.target.closest('.event-item');
            e.dataTransfer.setData('text/plain', eventElement.getAttribute('data-event-id'));
            eventElement.classList.add('drag-ghost');
        }

        function allowDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drop-zone', 'active');
        }

        function dropEvent(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drop-zone', 'active');

            const eventId = e.dataTransfer.getData('text/plain');
            const eventObj = events.find(ev => ev.id === eventId);
            if (!eventObj) return;

            const cell = e.currentTarget;
            const dayElement = cell.querySelector('.text-text-primary, .text-text-secondary');
            if (!dayElement) return;

            const day = parseInt(dayElement.textContent);
            const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            const newDateStr = formatDate(newDate);

            if (hasTimeConflict(newDateStr, eventObj.time, eventObj.id)) {
                showToast('Time conflict — this time is already occupied.', 'error');
                return;
            }

            eventObj.date = newDateStr;
            saveEventsToStorage();
            scheduleRemindersForAllEvents();
            renderCalendar();

            showToast('Event rescheduled successfully', 'success');
        }

        // Category filtering
        function filterEventsByCategory() {
            const checkboxes = document.querySelectorAll('.category-filter');
            if (!checkboxes || checkboxes.length === 0) return;

            const checkedCategories = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.dataset.category);

            document.querySelectorAll('.event-item').forEach(eventElement => {
                const eventId = eventElement.getAttribute('data-event-id');
                const ev = events.find(e => e.id === eventId);
                if (ev && checkedCategories.includes(ev.category)) {
                    eventElement.style.display = 'block';
                } else {
                    eventElement.style.display = 'none';
                }
            });
        }

        function updateCategoryCounts() {
            const categoryCounts = {
                work: events.filter(e => e.category === 'work').length,
                personal: events.filter(e => e.category === 'personal').length,
                health: events.filter(e => e.category === 'health').length,
                social: events.filter(e => e.category === 'social').length
            };

            Object.entries(categoryCounts).forEach(([category, count]) => {
                const countElement = document.querySelector(`.category-count[data-category="${category}"]`);
                if (countElement) {
                    countElement.textContent = count;
                }
            });
        }

        // Upcoming tasks
        function isValidTaskObject(task) {
            if (!task || typeof task !== 'object') return false;
            if (!task.title) return false;
            if (!task.dueDate) return false;
            if (!task.status) task.status = 'pending';
            return true;
        }

        function parseDateSafe(value) {
            if (!value) return null;
            if (value instanceof Date) {
                if (isNaN(value)) return null;
                return value;
            }
            if (typeof value === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(value)) {
                const d = new Date(value + 'T00:00:00');
                return isNaN(d) ? null : d;
            }
            const d = new Date(value);
            return isNaN(d) ? null : d;
        }

        function completeTaskFromDashboard(taskId) {
            try {
                const tasks = JSON.parse(localStorage.getItem('tasks') || '[]');
                const idx = tasks.findIndex(t => t.id === taskId);
                if (idx === -1) return;
                tasks[idx].status = 'completed';
                tasks[idx].completedAt = new Date().toISOString();
                localStorage.setItem('tasks', JSON.stringify(tasks));
                loadUpcomingTasks();
                showToast('Task marked complete', 'success');
            } catch (err) {
                console.error('Error completing task from dashboard', err);
                showToast('Failed to complete task', 'error');
            }
        }

        function loadUpcomingTasks() {
            const container = document.getElementById('upcomingTasksContainer');
            let tasksRaw = [];
            try {
                tasksRaw = JSON.parse(localStorage.getItem('tasks') || '[]');
                if (!Array.isArray(tasksRaw)) tasksRaw = [];
            } catch (err) {
                console.error('Failed to read tasks from storage', err);
                tasksRaw = [];
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const upcomingTasks = tasksRaw.filter(t => {
                if (!isValidTaskObject(t)) return false;
                if (t.status === 'completed') return false;
                const due = parseDateSafe(t.dueDate);
                if (!due) return false;
                due.setHours(0, 0, 0, 0);
                return due >= today;
            }).sort((a, b) => {
                const da = parseDateSafe(a.dueDate) || new Date(0);
                const db = parseDateSafe(b.dueDate) || new Date(0);
                return da - db;
            }).slice(0, 3);

            if (upcomingTasks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-sm text-text-secondary">No upcoming tasks</p>
                        <a href="task_management.html" class="text-xs text-primary hover:text-primary-700">Create your first task</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = upcomingTasks.map(task => {
                const priorityClass = task.priority === 'high' ? 'bg-error-100' :
                                   task.priority === 'medium' ? 'bg-warning-100' : 'bg-success-100';
                const priorityTextClass = task.priority === 'high' ? 'text-error-600' :
                                        task.priority === 'medium' ? 'text-warning-600' : 'text-success-600';

                const tid = task.id || ('t_' + (Date.now().toString(36) + Math.random().toString(36).substr(2, 5)));

                return `
                    <div class="flex items-center space-x-3 p-3 ${priorityClass} rounded-lg">
                        <input type="checkbox" class="w-4 h-4 text-primary" onchange="completeTaskFromDashboard('${tid}')" ${task.status === 'completed' ? 'checked' : ''} />
                        <div class="flex-1">
                            <p class="text-sm font-medium text-text-primary">${(task.title || '').replace(/</g, "&lt;")}</p>
                            <p class="text-xs ${priorityTextClass}">Due: ${(() => {
                                const d = parseDateSafe(task.dueDate);
                                return d ? d.toLocaleDateString() : task.dueDate;
                            })()}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Storage listener
        window.addEventListener('storage', function(e) {
            if (!e) return;
            if (e.key === 'calendarEvents') {
                loadEventsFromStorage();
                renderCalendar();
            }
            if (e.key === 'tasks') {
                loadUpcomingTasks();
            }
            if (e.key === 'schedulerSettings') {
                loadReminderSettings();
                renderCalendar();
            }
        });

        // Toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const messageEl = document.getElementById('toastMessage');

            if (!toast || !messageEl || !icon) return;

            messageEl.textContent = message;

            icon.className = type === 'success' ? 'fas fa-check-circle text-success' :
                           type === 'error' ? 'fas fa-exclamation-circle text-error' :
                           'fas fa-info-circle text-accent';

            toast.classList.remove('translate-x-full');
            toast.classList.add('translate-x-0');

            setTimeout(() => {
                hideToast();
            }, 3000);
        }

        function hideToast() {
            const toast = document.getElementById('toast');
            if (!toast) return;
            toast.classList.remove('translate-x-0');
            toast.classList.add('translate-x-full');
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        const quickTitle = document.getElementById('quickEventTitle');
                        if (quickTitle) quickTitle.focus();
                        break;
                    case 't':
                        e.preventDefault();
                        window.location.href = 'task_management.html';
                        break;
                    case 'f':
                        e.preventDefault();
                        window.location.href = 'search_and_filter.html';
                        break;
                }
            }

            if (e.key === 'Escape') {
                closeModal();
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadReminderSettings();
            requestNotificationPermissionIfNeeded();
            loadEventsFromStorage();
            updateCurrentDateDisplay();
            renderCalendar();
            loadUpcomingTasks();

            const todayStr = new Date().toISOString().split('T')[0];
            const quickDateEl = document.getElementById('quickEventDate');
            if (quickDateEl) quickDateEl.value = todayStr;

            document.addEventListener('dragend', function() {
                document.querySelectorAll('.event-item').forEach(eventElement => {
                    eventElement.classList.remove('drag-ghost');
                });
                document.querySelectorAll('.drop-zone').forEach(zone => {
                    zone.classList.remove('drop-zone', 'active');
                });
            });

            window.addEventListener('focus', () => {
                loadReminderSettings();
                loadEventsFromStorage();
                renderCalendar();
                loadUpcomingTasks();
            });

            scheduleRemindersForAllEvents();
        });
    </script>
</body>
</html>
